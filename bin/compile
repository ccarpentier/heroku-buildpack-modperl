#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir> <env-dir>

# fail hard
set -o pipefail
# fail harder
set -eu
# move hidden files too, just in case
shopt -s dotglob

BUILD_DIR=$1
CACHE_DIR=$2

BUILDPACK=".modperl2_buildpack"
APACHE_BUNDLE="https://github.com/ccarpentier/heroku-buildpack-modperl/blob/master/httpd_2.4.6-mod_perl_2.0.10.tar.gz?raw=true"

cd $BUILD_DIR

mkdir -p $BUILDPACK && cd $BUILDPACK

echo "-----> Bundling Apache"
curl --silent --max-time 60 --location $APACHE_BUNDLE | tar xz

cd $BUILD_DIR

# cd $BUILD_DIR
#
# # move app things to www
# mkdir -p $CACHE_DIR/www
# mv * $CACHE_DIR/www
# if [ -f $CACHE_DIR/www/lib ]; then
#     mv $CACHE_DIR/www/lib .
# fi
# mv $CACHE_DIR/www .

cat >>boot.sh <<EOF
echo "Launching Apache"
EOF
